@page "/dashboard"
@inject HttpClient Http
@inject NavigationManager NavigationManager
@inject Frontend.Services.UserState UserState
@using System.Text.Json
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@using System.Text.Json.Nodes
@using System.Net.Http.Json
@using Frontend.Models

@if (!UserState.IsLoggedIn){
    <div class="alert alert-warning">
        You are not logged in. Please <a href="/login">login</a> to view your dashboard.
    </div>
}
else{
    <div class="row update justify-content-start align-items-start mb-3">
        <div class="col-lg-6 col-12 text-left order-1">
            <h2>@($"{UserState.CurrentUser.firstName} {UserState.CurrentUser.lastName}")</h2>
            <p>@UserState.CurrentUser.email</p>                    
            <EditForm class="form" Model="updateModel" OnValidSubmit="HandleUpdate">
                <h5>Update</h5>
                <InputText @bind-Value="updateModel.FirstName" placeholder="First Name" /><br>
                <InputText @bind-Value="updateModel.LastName" placeholder="Last Name" /><br>
                <InputText @bind-Value="updateModel.Password" placeholder="Password"/><br>
                <button type="submit" class="btn btn-primary">Update</button>
                <button type="button" class="btn btn-primary" @onclick="HandleDelete">Delete</button>
            </EditForm>
        </div>
        <div class="col-lg-6 col-12 text-left order-2">
            <div class="list-group mt-xl-0 mt-xl-0 mt-3">
                <h2>All Users</h2>
                @if (users.Count > 0){
                    @foreach (var user in users){
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="user-info p-2">
                                    <strong>@($"{user.firstName} {user.lastName}")</strong>
                                    <br />
                                    <small>@user.email</small>
                                </div>
                                <small class="text-muted">ID: @user.id</small>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
    <div class="row news justify-content-start align-items-start align-items-stretch mb-5">
        <h2>News</h2>
        <h6>Latest articles from the New York Times</h6><br><br>
        @if (articles != null && articles.Count > 0){ 
            @foreach (var article in articles.Take(numArticles)){
                <div class="d-flex col-xl-3 col-12 mb-3">
                    <div class="article p-3">
                        <a target="_blank" href="@article["url"]?.ToString()" 
                            style="text-decoration: none; color: black;">
                            <img
                                height="150" class="mb-3"
                                src="@article["img"]?.ToString()"
                            /><br>
                            <strong>@article["name"]?.ToString()</strong><br><br>
                            <small>@article["description"]?.ToString()</small>
                        </a>
                    </div>
                </div>
            }
        }
        @if (articles != null && numArticles < articles.Count) {
            <div class="col-12 text-left">
                <button style="border-radius: 3px" class="btn btn-primary" @onclick="ShowMoreArticles">
                    Show More
                </button>
            </div>
        }
    </div>
}

@code {
    // Define the model for the update form
    private List<User> users = new List<User>();
    private UpdateFormModel updateModel = new UpdateFormModel();
    private int numArticles = 4;
    public JsonArray articles;

    protected override async Task OnInitializedAsync(){
        // Initialize user state if not already done
        if (UserState.CurrentUser == null){
            await UserState.Initialize();
        }

        // Only fetch users if logged in
        if (UserState.IsLoggedIn){
            users = await Http.GetFromJsonAsync<List<User>>("http://localhost:5127/users");
            
            // Initialize update model with current user data
            updateModel.FirstName = UserState.CurrentUser.firstName;
            updateModel.LastName = UserState.CurrentUser.lastName;
            updateModel.Email = UserState.CurrentUser.email;
            updateModel.Password = UserState.CurrentUser.password;
        }
        else{
            // Redirect to login if not logged in
            NavigationManager.NavigateTo("/login");
        }
    
        Console.WriteLine("Dashboard initialized");
        var json = await Http.GetStringAsync("https://react-api.up.railway.app/read");
        articles = JsonNode.Parse(json).AsArray();
    
        /*foreach (var article in articles){
            foreach (var prop in article.AsObject()){
                Console.WriteLine($"{prop.Key}: {prop.Value}");
            }
        }*/

    }    
    
    // Handle the form async for API
    private async Task HandleUpdate(){
        if (UserState.CurrentUser != null){
            // Update the user data with the form values
            var updatedUser = new User{
                id = UserState.CurrentUser.id,
                firstName = updateModel.FirstName,
                lastName = updateModel.LastName,
                email = updateModel.Email,
                password = updateModel.Password
            };
            
            // Send PUT request to update user in backend
            var response = await Http.PutAsJsonAsync($"http://localhost:5127/users/{updatedUser.id}", updatedUser);
            
            if (response.IsSuccessStatusCode){

                // Get the updated user from backend
                var refreshedUser = await Http.GetFromJsonAsync<User>($"http://localhost:5127/users/{updatedUser.id}");
                UserState.CurrentUser = refreshedUser;

                // Update the users list
                users = await Http.GetFromJsonAsync<List<User>>("http://localhost:5127/users");
            }
            else{
                Console.WriteLine($"Failed to update user: {await response.Content.ReadAsStringAsync()}");
            }
        }
    }
  
  // Handle delete
    private async Task HandleDelete(){
        if (UserState.CurrentUser != null){
            // Call API to delete user
            var response = await Http.DeleteAsync($"http://localhost:5127/users/{UserState.CurrentUser.id}");
            
            if (response.IsSuccessStatusCode){
                // Clear UserState and redirect to login
                await UserState.Logout();
                NavigationManager.NavigateTo("/login");
            }
            else{
                // Handle error (e.g., show message)
                Console.WriteLine("Failed to delete user");
            }
        }
    }

    private void ShowMoreArticles(){
        if (articles != null && numArticles < articles.Count){
            numArticles = Math.Min(numArticles + 2, articles.Count);
        }
    }

    public class UpdateFormModel{
        public string? FirstName { get; set; }
        public string? LastName { get; set; }
        public string? Email { get; set; }
        public string? Password { get; set; }   
    }
}